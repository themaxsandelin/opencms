apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{ basename }}-admin-api"
  namespace: "{{ namespace }}"
spec:
  replicas: {{ admin_api.replicas | int }}
  selector:
    matchLabels:
      app: "{{ basename }}-admin-api"
  template:
    metadata:
      labels:
        app: "{{ basename }}-admin-api"
        prometheus: nodejs
    spec:      
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      containers:
      - name: "{{ basename }}-admin-api"
        image: "registry1.redcatsnordic.ad:5000/{{ basename }}-admin-api:{{ version }}"
        resources:
          requests:
            cpu: "{{ admin_api.resources.requests.cpu }}"
            memory: "{{ admin_api.resources.requests.memory }}"
        securityContext:
          allowPrivilegeEscalation: false
        ports:
        - containerPort: {{ admin_api.port | int }}
          name: web
        volumeMounts:
        - mountPath: "/data"
          name: "opencms"
        - mountPath: "/app/env" 
          name: opnencmsenv
          readOnly: true
        env:
        - name: NX_DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: database-url
              key: database_url
      volumes:
      - name: opencms
        persistentVolumeClaim:
            claimName: pvc-opencms
      - name: opnencmsenv
        secret:
          secretName: env-opencms
          optional: false
        #readinessProbe:
        #  httpGet:
        #    path: /health/readiness
        #    port: {{ admin_api.port }}
        #  initialDelaySeconds: 30
        #  timeoutSeconds: 10
        #  periodSeconds: 10
        #livenessProbe:
        #  httpGet:
        #    path: /health/liveness
        #    port: {{ admin_api.port }}
        #  initialDelaySeconds: 30
        #  timeoutSeconds: 10
        #  periodSeconds: 30